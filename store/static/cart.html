<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
            padding: 20px;
            background-color: #333;
            color: white;
            margin-bottom: 20px;
        }
        .cart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            padding: 0 20px;
        }
        .cart-item {
            border: 1px solid #ddd;
            padding: 10px;
            width: 200px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .cart-item:hover {
            transform: translateY(-5px);
        }
        .cart-item .product-name {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }
        .cart-item .product-quantity {
            font-size: 16px;
            text-align: center;
        }
        button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }

    button:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
    }

    button:active {
        transform: translateY(0);
    }

    /* Стили для кнопки History */
    .history-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    /* Стили для контейнера истории */
    #history-container {
        display: none;
        margin-top: 20px;
    }
    .navigation {
            text-align: center;
            margin: 20px 0;
        }
        .navigation a {
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 10px;
            background-color: #333;
            color: white;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .navigation a:hover {
            background-color: #555;
        }
    </style>
    <script>
        let historyVisible = false;

async function togglePurchaseHistory() {
    const historyContainer = document.getElementById('history-container');

    if (historyVisible) {
        historyContainer.style.display = 'none';
        historyVisible = false;
        return;
    }

    try {
        const response = await fetch('/getPurchaseHistory', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
        });

        if (response.ok) {
            const historyItems = await response.json();
            console.log('Purchase History:', historyItems);
            historyContainer.innerHTML = '';
            historyContainer.style.display = 'flex';
            historyVisible = true;

            if (historyItems.length === 0) {
                historyContainer.innerHTML = '<p>No purchase history found.</p>';
            } else {
                historyItems.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('cart-item');

                    const productName = document.createElement('div');
                    productName.classList.add('product-name');
                    productName.textContent = `Product: ${item.product_name}`;
                    historyItem.appendChild(productName);

                    const productPrice = document.createElement('div');
                    productPrice.classList.add('product-price');
                    productPrice.textContent = `Price: $${item.price}`;
                    historyItem.appendChild(productPrice);

                    const purchaseDate = document.createElement('div');
                    purchaseDate.classList.add('product-price');
                    purchaseDate.textContent = `Date: ${new Date(item.purchase_date).toLocaleString()}`;
                    historyItem.appendChild(purchaseDate);

                    historyContainer.appendChild(historyItem);
                });
            }
        } else {
            alert('Failed to load purchase history');
        }
    } catch (error) {
        console.error('Error loading purchase history:', error);
        alert('Failed to load purchase history');
    }
}

        function showTransactionForm(productId) {
        const formContainer = document.getElementById('transaction-form-container');
        formContainer.style.display = 'block';
        document.getElementById('product-id').value = productId;
    }

    async function processTransaction(event) {
    event.preventDefault();
    
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const address = document.getElementById('address').value;
    const paymentMethod = document.getElementById('payment-method').value;
    const productId = document.getElementById('product-id').value;
    const transactionId = `txn_${Math.random().toString(36).substr(2, 9)}`;

    const requestData = {
        transaction_id: transactionId,
        amount: 100.00, // Подставляется динамически
        user_id: email,
        product_id: parseInt(productId),
        payment_method: paymentMethod,
        email: email,
        address: address,
        phone: phone,
        purchase_date: new Date().toISOString() // Дата в формате ISO 8601
    };

    try {
        const response = await fetch('/processTransaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });

        const result = await response.text();
        alert(result);
        document.getElementById('transaction-form-container').style.display = 'none';
    } catch (error) {
        console.error('Transaction failed:', error);
        alert('Transaction failed');
    }
}

    async function loadCartItems() {
    try {
        const response = await fetch('/getCartItems', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
        });

        if (response.ok) {
            const cartItems = await response.json();
            console.log('Cart Items:', cartItems);
            const cartContainer = document.getElementById('cart-container');
            cartContainer.innerHTML = '';

            if (cartItems.length === 0) {
                cartContainer.innerHTML = '<p>Your cart is empty.</p>';
            } else {
                cartItems.forEach(item => {
                    const cartItem = document.createElement('div');
                    cartItem.classList.add('cart-item');

                    const productName = document.createElement('div');
                    productName.classList.add('product-name');
                    productName.textContent = `Product: ${item.product_name}`;
                    cartItem.appendChild(productName);

                    const productPrice = document.createElement('div');
                    productPrice.classList.add('product-price');
                    productPrice.textContent = `Price: $${item.price}`;
                    cartItem.appendChild(productPrice);


                    // Add the Buy button
                    const buyButton = document.createElement('button');
                    buyButton.textContent = 'Buy';
                    buyButton.onclick = () => showTransactionForm(item.product_id); // Show transaction form
                    cartItem.appendChild(buyButton);

                    cartContainer.appendChild(cartItem);
                });
            }
        } 
    } catch (error) {
        console.error('Error loading cart items:', error);
        alert('Failed to load cart items');
    }
}


        window.onload = loadCartItems;
    </script>
</head>
<body>
    <h1>Your Cart</h1>
    <div class="navigation">
        <a href="index.html">Home</a>
        <a href="catalog.html">Catalog</a>
    </div>

    <div id="cart-container" class="cart-container"></div>
    <div id="transaction-form-container" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background:white; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.5);">
        <h3>Complete Transaction</h3>
        <form onsubmit="processTransaction(event)" style="display: flex; flex-direction: column; gap: 10px;">
            <label for="name">Full Name:</label>
            <input type="text" id="name" required>
    
            <label for="address">Address:</label>
            <input type="text" id="address" required>

            <label for="phone">Phone:</label>
            <input type="text" id="phone" required>
    
            <label for="email">Email:</label>
            <input type="email" id="email" required>
    
            <label for="payment-method">Payment Method:</label>
            <select id="payment-method" required>
                <option value="card">Credit/Debit Card</option>
                <option value="paypal">PayPal</option>
                <option value="applepay">Apple Pay</option>
            </select>
            
            <label for="card">Card number:</label>
            <input type="text" id="card" required>

            <input type="hidden" id="product-id">
            <button type="submit">Confirm Payment</button>
            <button type="button" onclick="document.getElementById('transaction-form-container').style.display='none'">Cancel</button>
        </form>
    </div>
    <div class="history-container">
        <button onclick="togglePurchaseHistory()">History</button>
    </div>
    
    <div id="history-container" class="cart-container"></div>

    
</body>
</html>
