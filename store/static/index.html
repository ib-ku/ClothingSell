<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bv & Bl</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .img-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .img-container img {
            width: 100%; 
            height: auto; 
        }
        .img-container button {
            margin-top: 10px; 
        }
        .icon-large {
            font-size: 3rem; /* Icon size */
            margin-bottom: 10px; /* Spacing */
        }
        
        /* Chat box styling */
        #chat-box {
            width: 300px;
            height: 400px;
            border: 1px solid #ccc; /* Light grey border */
            overflow-y: scroll;
            padding: 10px;
            background-color: #fff; /* White background */
            color: #000; /* Black text */
        }
        #chat-input {
            width: calc(100% - 50px);
            padding: 10px;
            background-color: #f2f2f2; /* Very light grey for input */
            border: 1px solid #ccc;
            color: #000;
        }
        #chat-log {
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000;
        }
        .user {
            color: #000; /* User messages in black */
        }
        .bot {
            color: #333; /* Bot messages in dark grey */
        }
        
        /* Button to open the chat */
        .chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #333; /* Black background */
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1000;
        }
        
        /* Chat window styles */
        .chat-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background-color: #fff; /* White background */
            border: 1px solid #ccc; /* Light grey border */
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 1001;
        }
        .chat-header {
            background-color: #eee; /* Bright light grey header */
            color: #000;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        .close-btn {
            background: none;
            border: none;
            color: #000;
            font-size: 20px;
            cursor: pointer;
        }
        .chat-body {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid #ccc;
        }
        .chat-input {
            padding: 10px;
            width: 100%;
            border: none;
            border-top: 1px solid #ccc;
            box-sizing: border-box;
            background-color: #f9f9f9; /* Very light background */
            color: #000;
        }
        .send-btn {
            padding: 10px;
            background-color: #333; /* Black send button */
            color: #fff;
            border: none;
            width: 100%;
            border-radius: 0 0 10px 10px;
            cursor: pointer;
        }
    </style>
    
    
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm bg-dark fixed-top py-3">
            <div class="container-fluid">
                <a class="navbar-brand text-white" href="index.html">Bv & Bl</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="registration.html">Registration</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="login.html">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="catalog.html" onclick="checkCatalogLogin(event)">Catalog</a>
                            <p id="catalogWarning" style="color: red; display: none;">Not logged in</p>
                        </li>
                    </ul>
                    <ul class="navbar-nav" id="adminPanelNav" style="display: none;">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin.html">Admin Panel</a>
                        </li>
                    </ul>
                    
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="cart.html">
                                <i class="fas fa-shopping-cart"></i> Cart
                            </a>
                        </li>
                    </ul>
                    <ul class="navbar-nav" id="userNav" style="display: none;">
                        <li class="nav-item">
                            <span class="nav-link text-white" id="usernameDisplay"></span>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-outline-light" id="logoutBtn">Logout</button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>


    <main>
        <div class="container">
            <div class="row">
                <div class="col-12 col-md-4 text-center mb-4 img-container">
                    <i class="fas fa-tshirt icon-large"></i>
                    <img src="https://static.zara.net/assets/public/d15f/14c0/88514fb8b7f1/2b8b2414f632/04806401800-e1/04806401800-e1.jpg?ts=1734946681063&w=850" alt="Black Jeans" class="img-fluid">
                    <button type="button" class="btn btn-secondary mt-3" onclick="checkLogin(event, 'black_jeans.html')">More...</button>
                    <p class="loginWarning" style="color: red; display: none;">Log in first</p>
                </div>
                <div class="col-12 col-md-4 text-center mb-4 img-container">
                    <i class="fas fa-shoe-prints icon-large"></i>
                    <img src="https://static.zara.net/assets/public/429e/4b44/bb7646b6a9c4/6aff2ce1329f/04087400251-e1/04087400251-e1.jpg?ts=1737028984288&w=850" alt="White T-Shirt" class="img-fluid">
                    <button type="button" class="btn btn-secondary mt-3" onclick="checkLogin(event, 'white_t_shirt.html')">More...</button>
                    <p class="loginWarning" style="color: red; display: none;">Log in first</p>
                </div>
                <div class="col-12 col-md-4 text-center mb-4 img-container">
                    <i class="fas fa-hat-cowboy icon-large"></i>
                    <img src="https://static.zara.net/assets/public/b155/37f7/ce8245aba1c2/0135179a768b/06792865401-e1/06792865401-e1.jpg?ts=1727775303398&w=850" alt="Pidjak" class="img-fluid">
                    <button type="button" class="btn btn-secondary mt-3" onclick="checkLogin(event, 'man_pidjak.html')">More...</button>
                    <p class="loginWarning" style="color: red; display: none;">Log in first</p>
                </div>
            </div>
        </div>
        

        <div class="container-fluid bg-dark text-white py-5">
            <div class="row">
                <div class="col-12 col-md-6 mb-4 mb-md-0">
                    <h2>Quote from our brand review by leading news</h2>
                    <p>From What World Says</p>
                    <blockquote>"Bv & Bl is not just a clothing store. We create basic items that emphasize <b><i>individuality</i></b> and become the basis of any wardrobe. Fashionable, high-quality and versatile clothing for men, women, and children - everything you need to create a style for every day."</blockquote>
                </div>
                <div class="col-12 col-md-6">
                    <h2>About us</h2>
                    <p id="textBig">We are a young company offering <b><i>fashionable and high-quality</i></b> clothing, creating basic items that will become indispensable elements of everyone's wardrobe. Our goal is to offer stylish and versatile solutions for everyday life that combine comfort, modern design, and durability.</p>
                </div>
            </div>
        </div>
        <button type="button" id="openChatBtn" class="chat-btn">Chat</button>

        <!-- Chat window -->
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <span>Chat</span>
                <button type="button" id="closeChatBtn">&times;</button>
            </div>
            <div class="chat-body" id="chatLog">
                <!-- Messages will appear here -->
            </div>
            <textarea id="chatInput" class="chat-input" placeholder="Type your message..."></textarea>
            <button type="button" id="sendBtn" class="send-btn">Send</button>
        </div>


        <section id="contact" class="mt-5 mb-0">
            <div class="bg-secondary text-white text-center footers">
                <footer py-4>
                    <h2>Bv & Bl</h2><br>
                    <p>The site is made by Abylay Moldakhmet SE-2306</p>
                    <button type="button" class="btn btn-outline-secondary"><a style="font-size: 20px;" href="https://t.me/bvbl1">Telegram</a><br><br></button>
                    <p>our mail: 230457@astanait.edu.kz</p>
                </footer>
            </div>
        </section>
    </main>

    <script>
document.addEventListener("DOMContentLoaded", function () {
    const userNav = document.getElementById("userNav");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminPanelNav = document.getElementById("adminPanelNav");

    function checkAuth() {
        fetch("/getUser", { method: "GET", credentials: "include" })
            .then(response => {
                if (!response.ok) throw new Error("Unauthorized");
                return response.json();
            })
            .then(data => {
                if (data.email) {
                    usernameDisplay.textContent = data.email;
                    userNav.style.display = "flex";

                    if (data.role === "admin") {
                        adminPanelNav.style.display = "flex";
                    } else {
                        adminPanelNav.style.display = "none";
                    }
                } else {
                    userNav.style.display = "none";
                    adminPanelNav.style.display = "none";
                }
            })
            .catch(() => {
                document.cookie = "Authorization=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 UTC;";
                userNav.style.display = "none";
                adminPanelNav.style.display = "none";
            });
    }

    logoutBtn.addEventListener("click", function () {
        fetch("/logout", { method: "POST", credentials: "include" })
            .then(() => {
                document.cookie = "Authorization=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 UTC;";
                usernameDisplay.textContent = "";
                userNav.style.display = "none";
                adminPanelNav.style.display = "none";
                window.location.href = "/index.html";
            });
    });

    checkAuth(); // Run authentication check on page load
});
function checkLogin(event, url) {
                event.preventDefault();
                const warningMessage = event.target.parentElement.querySelector(".loginWarning");
    
                fetch("/getUser", {
                    method: "GET",
                    credentials: "include"
                })
                .then(response => response.json())
                .then(data => {
                    if (data.email) { // Проверяем email вместо username
                        window.location.href = url;
                    } else {
                        warningMessage.style.display = "block";
                    }
                })
                .catch(error => {
                    console.error("Error checking login:", error);
                    warningMessage.style.display = "block";
                });
            }
    
            function checkCatalogLogin(event) {
                event.preventDefault(); // Останавливаем переход по ссылке
    
                const warningMessage = document.getElementById("catalogWarning");
    
                fetch("/getUser", {
                    method: "GET",
                    credentials: "include"
                })
                .then(response => response.json())
                .then(data => {
                    if (data.email) { // Проверяем email вместо username
                        window.location.href = "catalog.html"; // Если залогинен, переходим
                    } else {
                        warningMessage.style.display = "block"; // Показываем ошибку
                    }
                })
                .catch(error => {
                    console.error("Error checking login:", error);
                    warningMessage.style.display = "block";
                });
            }
// --- WebSocket Chat Logic ---
document.getElementById('openChatBtn').addEventListener('click', function() {
    document.getElementById('chatWindow').style.display = 'flex';
});

// FIX: Ensure the close button hides the chat window
document.getElementById('closeChatBtn').addEventListener('click', function() {
    document.getElementById('chatWindow').style.display = 'none';
});

document.addEventListener("DOMContentLoaded", function () {
    const socket = new WebSocket('ws://localhost:8085/chat');
    const chatLog = document.getElementById('chatLog');
    let lastUserMessage = ""; // Store last sent message to prevent duplication

    socket.onopen = function () {
        console.log("WebSocket Connected");
    };

    socket.onerror = function (error) {
        console.error("WebSocket Error:", error);
    };

    // --- Prevent duplicate messages ---
    socket.onmessage = function (event) {
        const message = JSON.parse(event.data);

        if (message.sender === "User" && message.message === lastUserMessage) {
            return; // Skip duplicate messages
        }

        appendMessage(message.sender, message.message);
    };

    // --- Updated Function to Display Messages with Clickable Links ---
    function appendMessage(sender, messageText) {
        const newMessage = document.createElement('div');

        if (sender === 'Bot') {
            newMessage.classList.add('bot');
            newMessage.innerHTML = `Chat: ${convertLinksToAnchor(messageText)}`; // Converts links
        } else {
            newMessage.classList.add('user');
            newMessage.textContent = `User: ${messageText}`;
        }

        chatLog.appendChild(newMessage);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // --- Function to Detect and Convert URLs into Clickable Links ---
    function convertLinksToAnchor(text) {
        return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    // --- Send Message ---
    document.getElementById('sendBtn').addEventListener('click', function() {
        const input = document.getElementById('chatInput');
        const messageText = input.value.trim();

        if (messageText !== '') {
            lastUserMessage = messageText; // Store sent message

            appendMessage("User", messageText); // Display in chat before sending

            // Send message to WebSocket server
            const message = {
                chatId: "some-unique-chat-id",
                sender: "User",
                message: messageText,
                timestamp: new Date().toISOString(),
                isActive: true
            };

            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            } else {
                console.error("WebSocket is not connected.");
            }

            input.value = ''; // Clear input field
        }
    });

    // --- Send Message on Enter Key ---
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('sendBtn').click();
        }
    });
});



    </script>
</body>
</html>